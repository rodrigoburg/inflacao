<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8"/>
    <script type="text/javascript" src="http://codeorigin.jquery.com/jquery-2.0.3.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://dimplejs.org/dist/dimple.v2.0.0.min.js"></script>
    <script type="text/javascript">
    window.variacoes = null
    window.charts = []
    function inicializa() {
            
        var comprimento = 1000
        var altura = 600
        var ultima_data = "01/08/13"
          var svg = dimple.newSvg("#chartContainer", comprimento, altura);
          d3.csv("dados/teste_ipca.csv", function (data) {

              //variáveis de posição
              var posicao_y = 0,
                  posicao_x = 0,
                  top = 30,
                  left = 80,
                  margem_x = 320,
                  margem_y = 180,
                  width = 150,
                  height = 90

              //pega cada um dos recortes
              var recortes = dimple.getUniqueValues(data, "variavel");
        
              //acha a distância média no eixo X para cada peso
              var pesos = dimple.getUniqueValues(data, "peso");
              var distancia_x = (comprimento-margem_x)/pesos.length
        
              //acha o máximo e o mínimo do eixo Y
              max_min = achaMaxMin(recortes,data,ultima_data)
              var y_min = max_min[0]
              var y_max = max_min[1]
        
              // desenha um gráfico para cada um dos recortes
              charts = []
              recortes.forEach(function (recorte) {
                  //filtra o dado
                  data_filtrado = dimple.filterData(data,"variavel",recorte);
            
                  //acha as posições
                  posicao_x = left+data_filtrado[0].peso*distancia_x
                  posicao_y = top+achaPosicaoY(altura-margem_y,
                      y_min,
                      y_max,
                      data_filtrado[data_filtrado.length-1].valor)
            
                  //desenha o gráfico
                  var grafico = desenhaGrafico(svg,data_filtrado,posicao_x,posicao_y,width,height)
                  var item = {}
                  item["recorte"] = recorte
                  item["grafico"] = grafico
                  charts.push(item)
                  
            }, this);
            window.charts = charts
  
            //desenha um gráfico grande para servir de referência
            var novo_data = []
            var i = 0
            //só divide os dados: metade é o valor máximo, metade o mínimo
            //isso é necessário para que o eixo X fique no meio
            data_filtrado.forEach(function (dado){
                if (i == 0) {
                    dado.peso = 1
                    i = 1
                } else {
                    dado.peso = -1
                    i = 0
                }
            novo_data.push(dado)            
            },this)
            var bigChart = new dimple.chart(svg, novo_data);
            var y_grande = bigChart.addPctAxis("y","peso")
            y_grande.overrideMax = 1
            y_grande.overridemin = -1
            y_grande.title = "Variação final do preço"
            y_grande.ticks = 2
            var x_grande = bigChart.addMeasureAxis("x","data")
            x_grande.title = "Peso do produto no IPCA"
            bigChart.draw()
            y_grande.shapes.selectAll("text").remove();
            
            
          });
        
    }
    function desenhaGrafico (svg,data,posicao_x,posicao_y,width,height) {
        var myChart = new dimple.chart(svg, data);
        myChart.setBounds(posicao_x, posicao_y, width, height);
  
        //cria os eixos e os esconde
        var x = myChart.addTimeAxis("x", "data","%d/%m/%y","%Y");
        x.title = ""
        var y = myChart.addMeasureAxis("y", "valor");
        y.title = "Variação no preço (%)"
        y.ticks = 4
        var s = myChart.addSeries("variavel", dimple.plot.line);
        myChart.draw();
        
        //esconde os eixos
        jQuery(".dimple-axis").hide()
        jQuery(".dimple-gridline").hide()
        
        
        //coloca evento mouseover para mostrar os eixos e dar highlight
        //retira também
        s.shapes
            .on("mouseover", function (e) { mostraEixos(this) })
            .on("mouseout", function (e) { escondeEixos(this) })
        
        //faz o mesmo para os círculos, além de colocar e tirar a tooltip
        d3.selectAll("circle")
            .on("mouseover", function (e) {
                mostraEixos(this)
                var grafico = achaGrafico(this)
                dimple._showPointTooltip(e, this, grafico, grafico.series[0])
            })
            .on("mouseleave",function(e) {
                escondeEixos(this)
                var grafico = achaGrafico(this)
                dimple._removeTooltip(e, this, grafico, grafico.series[0])
        })       
        
        return myChart
        
    }
    
    function achaGrafico (evento) {
        var variavel = evento.id.split("_")[0]
        var charts = window.charts
        var grafico = null
        charts.forEach(function (chart) {
            if (chart.recorte == variavel) {
                grafico = chart.grafico
            }
        },this)
        return grafico        
    }
    
      function achaPosicaoY (altura,y_min,y_max,dado) {
          //acha o delta y
          var variacao_y = Math.abs(y_min) + Math.abs(y_max)
          //faz todos os dados ficarem positivos
          dado = parseFloat(dado) + Math.abs(y_min)
          //regra de três pra achar a posição
          posicao_y = altura*dado/variacao_y
          //inverte a posição e o sinal dela
          posicao_y = posicao_y - altura
          posicao_y = posicao_y * -1
          return posicao_y
      }
    
      function achaMaxMin(recortes,data,ultima_data) {
          //acha o máximo e o mínimo do acumulado de todos os recortes
          var variacoes = []
          recortes.forEach(function (recorte) {
              data_filtrado = dimple.filterData(data,"variavel",recorte)
              data_filtrado.forEach(function (dado) {
                  if (dado.data == ultima_data) {
                      variacoes.push(parseFloat(dado.valor))
                  }
              },this)
          } ,this)
          variacoes.sort(function (a,b) { return a - b})
          return [variacoes[0],variacoes[variacoes.length-1]]
      }
      
      function mostraEixos(evento) {
          variavel = evento.id.split("_")[0]
          //mostra os eixos do gráfico atual
          jQuery("path").each(function () {                
              if (this.id == variavel) {
                  jQuery(this).prev().show()          
                  jQuery(this).prev().prev().show()          
                  jQuery(this).prev().prev().prev().show()          
                  jQuery(this).prev().prev().prev().prev().show()          
                  jQuery(this).prev().prev().prev().prev().prev().show()          
                  
              }                
          })
          
          //dá destaque para o gráfico em questão e coloca todos os outros com menor opacidade
          jQuery("path").each(function() {
              if (this.id == variavel) {
                  jQuery(this).attr("opacity",1)
              } else {
                  jQuery(this).attr("opacity",0.2)
              }
          })
      }
      
      function escondeEixos(evento) { 
          variavel = evento.id.split("_")[0]
          jQuery("path").each(function () {   
              jQuery(this).attr("opacity",8)
              if (this.id == variavel) {
                  jQuery(this).prev().hide()
                  jQuery(this).prev().prev().hide()          
                  jQuery(this).prev().prev().prev().hide()          
                  jQuery(this).prev().prev().prev().prev().hide()          
                  jQuery(this).prev().prev().prev().prev().prev().hide()          
                            
              }                
          })
      }
    </script>

</head>
<body>
<div id="chartContainer"><script>inicializa();</script>
</div>
</body>
